---
apiVersion: v1
kind: Namespace
metadata:
  name: grype-operator-system

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grype-operator
  namespace: grype-operator-system

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grype-scanner
  namespace: grype-operator-system

---

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: grype-operator-admin
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]
- nonResourceURLs: ["*"]
  verbs: ["*"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: grype-scanner-default-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: grype-scanner-role
subjects:
- kind: ServiceAccount
  name: grype-scanner
  namespace: default

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: grype-scanner-admin
rules:
- apiGroups: ["*"]
  resources: ["*"]
  verbs: ["*"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: grype-scanner-admin-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: grype-scanner-admin
subjects:
- kind: ServiceAccount
  name: grype-scanner
  namespace: grype-operator-system



---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grype-operator
  namespace: grype-operator-system
  labels:
    app: grype-operator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grype-operator
  template:
    metadata:
      labels:
        app: grype-operator
    spec:
      serviceAccountName: grype-operator
      containers:
        - name: operator
          image: ttl.sh/grype-rohan:24h
          imagePullPolicy: IfNotPresent
          env:
            - name: OPERATOR_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
          # securityContext:  I commented these as they might cause issues in some environments
          #   allowPrivilegeEscalation: false
          #   runAsNonRoot: true
          #   runAsUser: 1000
          #   capabilities:
          #     drop:
          #       - ALL
          #   readOnlyRootFilesystem: true
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
      # securityContext: I commented these as they might cause issues in some environments
      #   fsGroup: 1000
      #   runAsNonRoot: true
      #   seccompProfile:
      #     type: RuntimeDefault

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grype-operator-config
  namespace: grype-operator-system
data:
  # Operator behavior
  scan-on-create: "true"
  scan-on-update: "true"
  
  # Scanner configuration
  scanner-image: "anchore/grype:latest"
  scanner-cpu-request: "100m"
  scanner-memory-request: "256Mi"
  scanner-cpu-limit: "500m"
  scanner-memory-limit: "512Mi"
  
  # Job settings
  job-ttl-seconds: "3600"
  job-backoff-limit: "2"
  
  # Excluded namespaces (comma-separated)
  excluded-namespaces: "kube-system,kube-public,kube-node-lease,grype-operator-system"

---
# Create scanner ServiceAccount in default namespace
apiVersion: v1
kind: ServiceAccount
metadata:
  name: grype-scanner
  namespace: default

---
# If you have other namespaces, create ServiceAccount there too
# Uncomment and modify as needed:
#
# apiVersion: v1
# kind: ServiceAccount
# metadata:
#   name: grype-scanner
#   namespace: production
# ---
# apiVersion: v1
# kind: ServiceAccount
# metadata:
#   name: grype-scanner
#   namespace: staging