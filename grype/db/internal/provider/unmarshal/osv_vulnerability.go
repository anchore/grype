package unmarshal

import (
	"encoding/json"
	"io"

	"github.com/google/osv-scanner/pkg/models"
)

// OSVVulnerability extends the osv-scanner Vulnerability model to support
// the "upstream" field used by some OSV databases (e.g. openEuler, BellSoft,
// R Sec) as an alternative to the standard "aliases" field for referencing CVEs.
type OSVVulnerability struct {
	models.Vulnerability
}

// UnmarshalJSON implements custom JSON unmarshaling that captures the "upstream"
// field and merges it into Aliases.
func (v *OSVVulnerability) UnmarshalJSON(data []byte) error {
	if err := json.Unmarshal(data, &v.Vulnerability); err != nil {
		return err
	}

	// Some OSV databases use "upstream" instead of "aliases" to reference CVEs
	var extra struct {
		Upstream []string `json:"upstream"`
	}
	if err := json.Unmarshal(data, &extra); err != nil {
		return err
	}

	if len(extra.Upstream) > 0 {
		v.Aliases = append(v.Aliases, extra.Upstream...)
	}

	return nil
}

func OSVVulnerabilityEntries(reader io.Reader) ([]OSVVulnerability, error) {
	return unmarshalSingleOrMulti[OSVVulnerability](reader)
}
