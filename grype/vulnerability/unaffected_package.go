package vulnerability

import (
	"regexp"
	"strings"

	"github.com/anchore/grype/grype/version"
)

var (
	// Alpine Root.io version pattern: -rXX007X (e.g., -r00071, -r10074)
	alpineRootIOPattern = regexp.MustCompile(`-r\d{2}07\d+`)
)

type UnaffectedPackage struct {
	CVE        string
	Package    string
	Constraint string
}

func (u UnaffectedPackage) Matches(pkgVersion string, format version.Format) (bool, error) {
	if strings.HasPrefix(u.Constraint, "version_contains ") {
		substring := strings.TrimPrefix(u.Constraint, "version_contains ")

		// Check for the substring (e.g., ".root.io")
		if strings.Contains(pkgVersion, substring) {
			return true, nil
		}

		// For Alpine packages, also check for -rXX007X pattern
		// This handles cases where Root.io uses the Alpine-specific pattern
		if substring == ".root.io" && format == version.ApkFormat {
			if alpineRootIOPattern.MatchString(pkgVersion) {
				return true, nil
			}
		}

		return false, nil
	}

	constraint, err := version.GetConstraint(u.Constraint, format)
	if err != nil {
		return false, err
	}

	v := version.NewVersion(pkgVersion, format)

	satisfied, err := constraint.Satisfied(v)
	if err != nil {
		return false, err
	}

	return satisfied, nil
}
