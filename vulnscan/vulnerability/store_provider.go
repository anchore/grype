package vulnerability

import (
	"fmt"

	"github.com/anchore/imgbom/imgbom/distro"
	"github.com/anchore/imgbom/imgbom/pkg"
	"github.com/anchore/vulnscan-db/pkg/db"
	"github.com/anchore/vulnscan/vulnscan/version"
)

type StoreProvider struct {
	store db.VulnerabilityStoreReader
	// TODO: allows the ability to have a db cache for keeping rich objects around
	// or to have a sync.Pool of warm objects
}

func NewProviderFromStore(store db.VulnerabilityStoreReader) *StoreProvider {
	return &StoreProvider{
		store: store,
	}
}

func (pr *StoreProvider) GetByDistro(d distro.Distro, p *pkg.Package) ([]*Vulnerability, error) {
	vulns := make([]*Vulnerability, 0)

	namespace := distroNamespace(d)
	allPkgVulns, err := pr.store.GetVulnerability(namespace, p.Name)
	if err != nil {
		return nil, fmt.Errorf("provider failed to fetch namespace='%s' pkg='%s': %w", namespace, p.Name, err)
	}

	for _, vuln := range allPkgVulns {
		format := version.ParseFormat(vuln.VersionFormat)

		constraint, err := version.GetConstraint(vuln.VersionConstraint, format)
		if err != nil {
			return nil, fmt.Errorf("provider failed to parse distro='%s' constraint='%s' format='%s': %w", d, vuln.VersionConstraint, format, err)
		}

		vulns = append(vulns, &Vulnerability{
			Constraint: constraint,
			ID:         vuln.ID,
		})
	}

	return vulns, nil
}

func (pr *StoreProvider) GetByLanguage(l pkg.Language, p *pkg.Package) ([]*Vulnerability, error) {
	vulns := make([]*Vulnerability, 0)

	namespaces := languageNamespaces(l)
	if namespaces == nil {
		return nil, fmt.Errorf("no store namespaces found for language '%s'", l)
	}

	for _, namespace := range namespaces {
		allPkgVulns, err := pr.store.GetVulnerability(namespace, p.Name)
		if err != nil {
			return nil, fmt.Errorf("provider failed to fetch namespace='%s' pkg='%s': %w", namespace, p.Name, err)
		}

		for _, vuln := range allPkgVulns {
			format := version.ParseFormat(vuln.VersionFormat)

			constraint, err := version.GetConstraint(vuln.VersionConstraint, format)
			if err != nil {
				return nil, fmt.Errorf("provider failed to parse language='%s' constraint='%s' format='%s': %w", l, vuln.VersionConstraint, format, err)
			}

			vulns = append(vulns, &Vulnerability{
				Constraint: constraint,
				ID:         vuln.ID,
			})
		}
	}

	return vulns, nil
}
